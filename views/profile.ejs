<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navbar -->
  <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-indigo-600">Gestão de Conta</h1>

    <div class="flex items-center space-x-4">
      <a href="/worksheets" 
        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
        Folhas de Obra
      </a>
      <form action="/logout" method="POST">
        <button type="submit" 
                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
          Logout
        </button>
      </form>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6 space-y-10">

    <!-- Perfil selecionado -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">
        Perfil de <span class="text-indigo-600"><%= currentUser.username %></span>
      </h2>

      <!-- Seleção de utilizador -->
      <form method="GET" action="/profile" class="mb-6">
        <label for="editUserId" class="block text-sm font-medium text-gray-700 mb-1">Selecionar utilizador:</label>
        <select name="editUserId" id="editUserId"
                onchange="this.form.submit()"
                class="w-full md:w-1/2 px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
          <% users.forEach(u => { %>
            <option value="<%= u.uid %>" <%= u.uid === selectedUser.uid ? 'selected' : '' %>>
              <%= u.username %> (<%= u.role %>)
            </option>
          <% }) %>
        </select>
      </form>

      <!-- Formulário de edição -->
      <h3 class="text-lg font-semibold text-gray-600 mb-4">Edição de atributos de <%= selectedUser.username %></h3>
      <form id="editForm" method="POST" action="/edit-user/<%= selectedUser.uid %>" class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input type="text" name="username" value="<%= selectedUser.username %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" name="email" value="<%= selectedUser.email %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
          <input type="text" name="name" value="<%= selectedUser.name || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
          <input type="text" name="telephone" value="<%= selectedUser.telephone || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Morada</label>
          <input type="text" name="address" value="<%= selectedUser.address || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
          <input type="text" name="postal_code" value="<%= selectedUser.postal_code || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ocupação</label>
          <input type="text" name="occupation" value="<%= selectedUser.occupation || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Local de Trabalho</label>
          <input type="text" name="workplace" value="<%= selectedUser.workplace || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">NIF</label>
          <input type="text" name="nif" value="<%= selectedUser.nif || '' %>"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Perfil</label>
          <select name="profile"
            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
            <option value="">-- Selecionar --</option>
            <option value="Público" <%= selectedUser.profile === 'Público' ? 'selected' : '' %>>Público</option>
            <option value="Privado" <%= selectedUser.profile === 'Privado' ? 'selected' : '' %>>Privado</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <button type="submit"
            class="w-full py-3 bg-indigo-600 text-white rounded-xl shadow hover:bg-indigo-700 transition">
            Guardar alterações
          </button>
        </div>
      </form>
    </section>

    <!-- Gestão de utilizadores -->
    <!-- (kept as is, since it doesn’t depend on missing helpers) -->

    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestão de Utilizadores</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100 text-gray-700">
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Email</th>
              <th class="px-4 py-2">Role Atual</th>
              <th class="px-4 py-2">Alterar Role</th>
              <th class="px-4 py-2">Estado</th>
              <th class="px-4 py-2">Remover</th>
            </tr>
          </thead>
          <tbody class="text-center">
            <% users.forEach(u => { %>
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2"><%= u.username %></td>
                <td class="px-4 py-2"><%= u.email %></td>
                <td class="px-4 py-2"><%= u.role %></td>
                <td class="px-4 py-2">
                  <% if (currentUser.role === 'ADMIN' || (currentUser.role === 'BACKOFFICE' && (u.role === 'ENDUSER' || u.role === 'PARTNER'))) { %>
                    <form action="/change-role/<%= u.uid %>" method="POST" class="flex space-x-2 justify-center">
                      <select name="newRole" class="px-2 py-1 border rounded-lg text-sm">
                        <% if (currentUser.role === 'ADMIN') { %>
                          <option value="ENDUSER" <%= u.role === 'ENDUSER' ? 'selected' : '' %>>ENDUSER</option>
                          <option value="BACKOFFICE" <%= u.role === 'BACKOFFICE' ? 'selected' : '' %>>BACKOFFICE</option>
                          <option value="PARTNER" <%= u.role === 'PARTNER' ? 'selected' : '' %>>PARTNER</option>
                          <option value="ADMIN" <%= u.role === 'ADMIN' ? 'selected' : '' %>>ADMIN</option>
                        <% } else if (currentUser.role === 'BACKOFFICE') { %>
                          <% if (u.role === 'ENDUSER') { %>
                            <option value="ENDUSER" selected>ENDUSER</option>
                            <option value="PARTNER">PARTNER</option>
                          <% } else if (u.role === 'PARTNER') { %>
                            <option value="PARTNER" selected>PARTNER</option>
                            <option value="ENDUSER">ENDUSER</option>
                          <% } %>
                        <% } %>
                      </select>
                      <button type="submit" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-600">Atualizar</button>
                    </form>
                  <% } else { %>
                    <em>-</em>
                  <% } %>
                </td>
                <td class="px-4 py-2">
                  <% if (currentUser.role === 'ADMIN' || currentUser.role === 'BACKOFFICE') { %>
                    <form action="/change-status/<%= u.uid %>" method="POST">
                      <button type="submit" class="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600">
                        <%= u.status === 'ATIVADA' ? 'Desativar' : 'Ativar' %>
                      </button>
                    </form>
                  <% } else { %>
                    <%= u.status %>
                  <% } %>
                </td>
                <td class="px-4 py-2">
                  <% if (currentUser.role === 'ADMIN' || (currentUser.role === 'BACKOFFICE' && (u.role === 'ENDUSER' || u.role === 'PARTNER'))) { %>
                    <form action="/delete-user/<%= u.uid %>" method="POST" onSubmit="return confirm('Tem a certeza que quer remover esta conta?');">
                      <button type="submit" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                        Remover
                      </button>
                    </form>
                  <% } else { %>
                    <em>-</em>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Mudar Password -->
    <!-- unchanged, already safe -->

    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Mudar Password</h2>
      <form action="/change-password" method="POST" class="grid gap-4 max-w-md">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password atual</label>
          <input type="password" name="currentPassword" required class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nova password</label>
          <input type="password" name="newPassword" required class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar nova password</label>
          <input type="password" name="confirmPassword" required class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500">
        </div>
        <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl shadow hover:bg-indigo-700 transition">
          Alterar Password
        </button>
      </form>
    </section>

    <!-- Token -->
    <!-- unchanged, already safe -->

    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Token de Sessão</h2>
      <% if (currentUser.token) { %>
        <div class="bg-gray-100 p-4 rounded-xl mb-4 text-sm text-gray-700">
          <p><strong>USER:</strong> <%= currentUser.token.USER %></p>
          <p><strong>ROLE:</strong> <%= currentUser.token.ROLE %></p>
          <p><strong>VALID_FROM:</strong> <%= currentUser.token.VALIDITY.VALID_FROM %></p>
          <p><strong>VALID_TO:</strong> <%= currentUser.token.VALIDITY.VALID_TO %></p>
        </div>
        <button onclick="copyToken()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
          Copiar Token
        </button>
        <script>
          function copyToken() {
            const tokenData = `
USER: <%= currentUser.token.USER %>
ROLE: <%= currentUser.token.ROLE %>
VALID_FROM: <%= currentUser.token.VALIDITY.VALID_FROM %>
VALID_TO: <%= currentUser.token.VALIDITY.VALID_TO %>
VERIFICADOR: <%= currentUser.token.VALIDITY.VERIF %>
            `.trim();
            navigator.clipboard.writeText(tokenData).then(() => {
              alert("Token copiado para a área de transferência!");
            });
          }
        </script>
      <% } else { %>
        <p class="text-red-500">Token não disponível.</p>
      <% } %>
    </section>

  </main>
</body>
</html>
